<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDINET RAG System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1E3A8A;
            --secondary-color: #3B82F6;
            --success-color: #10B981;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-top: 30px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .sidebar {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            height: 100%;
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .user-message {
            background: var(--secondary-color);
            color: white;
            margin-left: auto;
        }
        
        .bot-message {
            background: #e9ecef;
            color: #212529;
        }
        
        .source-item {
            background: white;
            border-left: 4px solid var(--success-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: #1e40af;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online { background: #10B981; }
        .offline { background: #EF4444; }
        
        @media (max-width: 768px) {
            .sidebar {
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="main-container">
                    <div class="row">
                        <!-- ä¾§è¾¹æ  -->
                        <div class="col-md-4 col-lg-3 sidebar">
                            <div class="text-center mb-5">
                                <i class="fas fa-file-invoice-dollar fa-3x mb-3"></i>
                                <h2>EDINET RAG</h2>
                                <p class="text-light">æœ‰ä¾¡è¨¼åˆ¸å ±å‘Šæ›¸åˆ†æã‚·ã‚¹ãƒ†ãƒ </p>
                            </div>
                            
                            <div class="mb-4">
                                <h5><i class="fas fa-cog me-2"></i>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h5>
                                <div id="system-status">
                                    <p><span class="status-indicator offline" id="status-indicator"></span>
                                    <span id="status-text">æ¥ç¶šç¢ºèªä¸­...</span></p>
                                    <p id="document-count">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: 0</p>
                                    <p id="company-count">ä¼šç¤¾æ•°: 0</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5><i class="fas fa-search me-2"></i>æ¤œç´¢è¨­å®š</h5>
                                <div class="mb-3">
                                    <label class="form-label text-light">æ¤œç´¢æ•°</label>
                                    <input type="range" class="form-range" id="topK" min="1" max="10" value="5">
                                    <div class="d-flex justify-content-between">
                                        <small>1</small>
                                        <small id="topK-value">5</small>
                                        <small>10</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5><i class="fas fa-bolt me-2"></i>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-light btn-sm" onclick="searchEdinet()">
                                        <i class="fas fa-search me-1"></i>EDINETæ¤œç´¢
                                    </button>
                                    <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                        <i class="fas fa-trash me-1"></i>å±¥æ­´å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-5">
                                <small class="text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0<br>
                                    ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: EDINET
                                </small>
                            </div>
                        </div>
                        
                        <!-- ä¸»å†…å®¹åŒº -->
                        <div class="col-md-8 col-lg-9 p-4">
                            <h3 class="mb-4">
                                <i class="fas fa-comments me-2"></i>ãƒãƒ£ãƒƒãƒˆæ¤œç´¢
                            </h3>
                            
                            <!-- èŠå¤©åŒºåŸŸ -->
                            <div class="chat-container mb-4" id="chat-container">
                                <div class="text-center text-muted p-5" id="empty-chat">
                                    <i class="fas fa-comment-dots fa-3x mb-3"></i>
                                    <p>è³ªå•ã‚’å…¥åŠ›ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„</p>
                                </div>
                            </div>
                            
                            <!-- è¾“å…¥åŒºåŸŸ -->
                            <div class="mb-3">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="company-filter" 
                                           placeholder="ä¼šç¤¾åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ä»»æ„)">
                                </div>
                                <div class="input-group mb-3">
                                    <textarea class="form-control" id="question-input" 
                                              rows="3" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="btn-group me-2">
                                            <button class="btn btn-outline-primary btn-sm" onclick="useExample(0)">
                                                å£²ä¸Šé«˜
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="useExample(1)">
                                                äº‹æ¥­ãƒªã‚¹ã‚¯
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm" onclick="useExample(2)">
                                                è²¡å‹™çŠ¶æ³
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="sendQuestion()" id="send-btn">
                                        <i class="fas fa-paper-plane me-2"></i>é€ä¿¡
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ç»“æœåŒºåŸŸ -->
                            <div id="results-area" class="d-none">
                                <h5 class="mt-4 mb-3">
                                    <i class="fas fa-chart-bar me-2"></i>æ¤œç´¢çµæœ
                                </h5>
                                <div id="sources-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // é…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';
        let chatHistory = [];
        
        // ç¤ºä¾‹é—®é¢˜
        const examples = [
            "ã“ã®ä¼šç¤¾ã®å£²ä¸Šé«˜ã¯ï¼Ÿ",
            "ä¸»è¦ãªäº‹æ¥­ãƒªã‚¹ã‚¯ã‚’æ•™ãˆã¦",
            "è²¡å‹™çŠ¶æ³ã®åˆ†æã¯ï¼Ÿ",
            "å½“æœŸç´”åˆ©ç›Šã®æ¨ç§»ã¯ï¼Ÿ"
        ];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateRangeValue();
            checkSystemStatus();
            
            // è¾“å…¥æ¡†å›è½¦å‘é€
            document.getElementById('question-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendQuestion();
                }
            });
            
            // èŒƒå›´æ»‘å—äº‹ä»¶
            document.getElementById('topK').addEventListener('input', updateRangeValue);
        });
        
        function updateRangeValue() {
            const slider = document.getElementById('topK');
            document.getElementById('topK-value').textContent = slider.value;
        }
        
        function useExample(index) {
            if (index < examples.length) {
                document.getElementById('question-input').value = examples[index];
            }
        }
        
        async function checkSystemStatus() {
            try {
                const response = await axios.get(`${API_BASE}/status`);
                const status = response.data;
                
                document.getElementById('status-indicator').className = 'status-indicator online';
                document.getElementById('status-text').textContent = 'æ¥ç¶šæ¸ˆã¿';
                document.getElementById('document-count').textContent = 
                    `ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: ${status.vector_store_stats?.total_chunks || 0}`;
                
            } catch (error) {
                document.getElementById('status-indicator').className = 'status-indicator offline';
                document.getElementById('status-text').textContent = 'æœªæ¥ç¶š';
                console.error('çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        async function sendQuestion() {
            const questionInput = document.getElementById('question-input');
            const companyFilter = document.getElementById('company-filter');
            const sendBtn = document.getElementById('send-btn');
            
            const question = questionInput.value.trim();
            if (!question) {
                alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(question, 'user');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            questionInput.value = '';
            
            // ç¦ç”¨å‘é€æŒ‰é’®
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‡¦ç†ä¸­...';
            
            try {
                const payload = {
                    question: question
                };
                
                if (companyFilter.value.trim()) {
                    payload.company_filter = companyFilter.value.trim();
                }
                
                const response = await axios.post(`${API_BASE}/query`, payload, {
                    timeout: 60000
                });
                
                const result = response.data;
                
                // æ˜¾ç¤ºæœºå™¨äººå›å¤
                addMessage(result.answer, 'bot', result.sources);
                
                // ä¿å­˜åˆ°å†å²
                chatHistory.push({
                    question: question,
                    answer: result.answer,
                    time: new Date().toLocaleTimeString(),
                    sources: result.sources
                });
                
                // æ˜¾ç¤ºæ¥æº
                if (result.sources && result.sources.length > 0) {
                    showSources(result.sources);
                }
                
            } catch (error) {
                console.error('è³ªå•ã‚¨ãƒ©ãƒ¼:', error);
                addMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
            } finally {
                // æ¢å¤å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>é€ä¿¡';
            }
        }
        
        function addMessage(text, sender, sources = null) {
            const chatContainer = document.getElementById('chat-container');
            const emptyChat = document.getElementById('empty-chat');
            
            // éšè—ç©ºçŠ¶æ€
            if (emptyChat) {
                emptyChat.style.display = 'none';
            }
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const time = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="fw-bold">${sender === 'user' ? 'ğŸ‘¤ ã‚ãªãŸ' : 'ğŸ¤– RAGã‚·ã‚¹ãƒ†ãƒ '}</div>
                <div class="mb-2">${text}</div>
                <div class="small text-muted">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // å¦‚æœæœ‰æ¥æºï¼Œæ·»åŠ æ¥æºæŒ‰é’®
            if (sources && sources.length > 0) {
                const sourceBtn = document.createElement('button');
                sourceBtn.className = 'btn btn-sm btn-outline-primary mt-2';
                sourceBtn.innerHTML = `<i class="fas fa-file-alt me-1"></i>å‚ç…§å…ƒ (${sources.length})`;
                sourceBtn.onclick = () => showSources(sources);
                messageDiv.appendChild(sourceBtn);
            }
        }
        
        function showSources(sources) {
            const container = document.getElementById('sources-container');
            const resultsArea = document.getElementById('results-area');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ·»åŠ æ¯ä¸ªæ¥æº
            sources.forEach((source, index) => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'source-item';
                
                sourceDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>å‚ç…§å…ƒ ${index + 1}</strong>
                            <span class="badge bg-success ms-2">${(source.score * 100).toFixed(1)}% é¡ä¼¼</span>
                        </div>
                        <small class="text-muted">${source.company || 'ä¸æ˜'}</small>
                    </div>
                    <p class="mb-0">${source.text || ''}</p>
                `;
                
                container.appendChild(sourceDiv);
            });
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultsArea.classList.remove('d-none');
        }
        
        async function searchEdinet() {
            try {
                const response = await axios.get(`${API_BASE}/search/edinet?limit=5`);
                const result = response.data;
                
                alert(`${result.count}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                
            } catch (error) {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        function clearChat() {
            if (confirm('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const chatContainer = document.getElementById('chat-container');
                const emptyChat = document.getElementById('empty-chat');
                
                // æ¸…ç©ºèŠå¤©
                chatContainer.innerHTML = '';
                
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                if (emptyChat) {
                    emptyChat.style.display = 'block';
                }
                
                // éšè—ç»“æœåŒºåŸŸ
                document.getElementById('results-area').classList.add('d-none');
                
                // æ¸…ç©ºå†å²
                chatHistory = [];
                
                alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
        
        // å®šæ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>